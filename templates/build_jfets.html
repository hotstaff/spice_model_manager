<!DOCTYPE html>
<html lang="{% block lang_code %}en{% endblock %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block head_title %}SPICE Model Editor{% endblock %}</title>
    <!-- bokeh -->
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <style>
        /* Custom styles for the sliders */
        .noUi-horizontal {
            height: 8px;
            background: #ddd;
        }
        .noUi-handle {
            background: #4CAF50;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
        }

        /* Adjust the layout to prevent overlap */
        .parameter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .parameter-container input[type="text"] {
            flex: 1;
        }

        .parameter-container .slider-container {
            width: 100%;
        }

        .parameter-container .slider-container .noUi-slider {
            margin-top: 8px;
        }
    </style>


    <!-- Simulation Request -->
    <script type="text/javascript">
        // 非同期リクエストを送信し、結果をBokehで表示する関数
        async function runSimulation(event) {
            event.preventDefault();  // フォームのデフォルト送信を防ぐ

            
            const formData = new FormData(document.getElementById("build-form"));
            const runButton = document.getElementById("run-button");
            
            runButton.disabled = true; // ボタンを無効化
            runButton.classList.add('bg-gray-400', 'cursor-not-allowed');

            try {
                const response = await fetch("/api/simulate_now2", {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    alert("Simulation failed: " + response.statusText);
                    return;
                }

                const jsonData = await response.json();
                if (jsonData.error) {
                    alert("Error: " + jsonData.error);
                    return;
                }

                // Bokehプロットを表示するための処理
                const bokehDiv = document.getElementById("bokeh-plot");
                bokehDiv.innerHTML = '';  // 既存のプロットをクリア

                // Bokehプロットの埋め込み
                Bokeh.safely(function() {
                    // JSONデータが正しく埋め込まれるように処理
                    Bokeh.embed.embed_item(JSON.parse(jsonData), "bokeh-plot");
                });

                // 結果セクションを表示
                document.getElementById("result-section").style.display = "block";
            } catch (error) {
                console.error("Error during simulation:", error);
                alert("An unexpected error occurred. Please try again.");
            } finally {
                runButton.disabled = false;
                runButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        }

        // DOMが読み込まれた後にイベントリスナーを設定
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("build-form");
            form.addEventListener("submit", runSimulation);
        });
    </script>


</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div class="container mx-auto p-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">{% block title %}SPICE Model Editor{% endblock %}</h1>
            <h2 class="text-xl text-gray-600">{% block subtitle %}Create and customize your own SPICE models for simulation{% endblock %}</h2>
        </header>

        <!-- Flexbox Layout -->
        <div class="flex flex-wrap lg:flex-nowrap gap-6">
            <!-- Left Column: Forms -->
            <div class="w-full lg:w-1/3 space-y-6">
                <!-- Parameter Form -->
                <form id="parameter-form" class="bg-white p-6 rounded-lg shadow-md">
                    <!-- Device Name and Type -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="device-name" class="block text-lg font-semibold text-gray-700">{% block device_name %}Device Name{% endblock %}:</label>
                            <input type="text" id="device-name" name="device-name" class="w-full border rounded-lg py-2 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter device name" value="2SK555">
                        </div>
                        <div>
                            <label for="device-type" class="block text-lg font-semibold text-gray-700">{% block device_type %}Device Type{% endblock %}:</label>
                            <select id="device-type" name="device-type" class="w-full border rounded-lg py-2 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="NJF">NJF</option>
                                <option value="PJF">PJF</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <!-- Tabs -->
                    <ul class="flex border-b mb-6">
                        {% for i in range(0, parameters|length, 4) %}
                        <li class="mr-2">
                            <a href="#tab-{{ loop.index }}" class="inline-block py-2 px-4 {% if loop.index == 1 %}text-blue-500{% else %}text-gray-500{% endif %} hover:text-blue-700 font-semibold">T {{ loop.index }}</a>
                        </li>
                        {% endfor %}
                    </ul>

                    <!-- Tab Content -->
                    {% for i in range(0, parameters|length, 4) %}
                    <div id="tab-{{ loop.index }}" class="space-y-4 {% if loop.index != 1 %}hidden{% endif %}">
                        {% for param in parameters[i:i+4] %}
                            <div class="parameter-container">
                                <label for="value-{{ param.name }}" class="w-1/3 text-lg font-semibold text-gray-700">
                                    {% if param.unit %}
                                        {{ param.name }} ({{ param.unit }})
                                    {% else %}
                                        {{ param.name }}
                                    {% endif %}
                                </label>
                                <div class="slider-container flex-1">
                                    <input type="text" id="value-{{ param.name }}" title=" {{ param.description }}" class="w-full text-center border rounded-lg py-2 px-4" value="{{ param.default }}">
                                    {% if param.default is not string %}
                                    <div id="slider-{{ param.name }}" class="mt-2" data-prefix="{{ param.prefix }}"></div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% endfor %}

                </form>

                <!-- Build Form -->
                <form id="build-form" action="/api/simulate_now2" method="post" class="bg-white p-6 rounded-lg shadow-md">
                    <textarea id="spice-string" name="spice_string" placeholder="Enter SPICE model string here" required class="w-full h-30 p-3 text-lg border border-gray-300 rounded mb-4"></textarea>
                    <div class="form-row" style="display:none;">
                        <input type="text" name="author" placeholder="Your Name" maxlength="16" class="w-1/2 p-3 text-lg border border-gray-300 rounded mr-4">
                        <input type="text" name="comment" placeholder="Add a comment" maxlength="100" class="w-1/2 p-3 text-lg border border-gray-300 rounded">
                    </div>
                    
                    <!-- Button Container with Flexbox -->
                    <div class="flex justify-between mt-4">
                        <button id="run-button" type="submit" class="bg-blue-500 text-white font-semibold text-lg py-3 px-6 rounded hover:bg-blue-600 transition duration-300 w-1/3 mr-2">
                            {% block run_button_text %}Run Simulation{% endblock %}
                        </button>
                        <button id="default-button" type="button" class="bg-green-500 text-white font-semibold text-lg py-3 px-6 rounded hover:bg-green-600 transition duration-300 w-1/3 ml-2">
                            {% block default_button_text %}Default{% endblock %}
                        </button>
                        <button id="load-button" type="button" class="bg-orange-500 text-white font-semibold text-lg py-3 px-6 rounded hover:bg-orange-600 transition duration-300 w-1/3 ml-2">
                            {% block Load_button_text %}Load{% endblock %}
                        </button>
                    </div>

                </form>
            </div>

            <!-- Right Column: Result Section -->
            <div class="w-full lg:w-2/3">
                <div class="bg-white p-6 rounded-lg shadow-md" id="result-section" style="display: none;">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">{% block simulation_result_heading %}Simulation Result{% endblock %}</h3>
                    <div id="bokeh-plot" class="w-full h-full mb-4" style="max-width: 100%; max-height: 600px;"></div>
                    <p id="result-message" class="text-lg text-gray-600"></p>
                </div>
            </div>
        </div>

        <!-- Back to Home -->
        <p><a href="{{ url_for('home') }}" class="text-blue-500 text-lg hover:underline">{% block back_link %}Back to Home{% endblock %}</a></p>
    </div>

    <!-- Tab Click event -->
    <script>
        // タブのクリックイベントを設定
        document.querySelectorAll('a[href^="#tab-"]').forEach(tab => {
            tab.addEventListener('click', function(event) {
                event.preventDefault(); // デフォルトのリンク動作を無効化

                // すべてのタブを非アクティブにし、関連するコンテンツを非表示にする
                document.querySelectorAll('a[href^="#tab-"]').forEach(tabLink => {
                    tabLink.classList.remove('text-blue-700');
                    tabLink.classList.add('text-gray-500');
                });
                document.querySelectorAll('.space-y-4').forEach(tabContent => {
                    tabContent.classList.add('hidden');
                });

                // クリックされたタブをアクティブにし、関連するコンテンツを表示する
                this.classList.remove('text-gray-500');
                this.classList.add('text-blue-700');
                const targetTab = document.querySelector(this.getAttribute('href'));
                targetTab.classList.remove('hidden');
            });
        });

        // spice model string
        function generateModel() {
            const deviceName = document.getElementById('device-name').value;
            const deviceType = document.getElementById('device-type').value;
            let modelString = `.MODEL ${deviceName} ${deviceType}`;

            {% for param in parameters %}
                const paramValue{{ loop.index }} = document.getElementById('value-{{ param.name }}').value;
                const paramPrefix{{ loop.index }} = "{{ param.prefix }}";  // Get the prefix (e.g., 'p', 'u', etc.)

                if (Number(paramValue{{ loop.index }}) !== Number({{ param.default }})) {
                    modelString += ` {{ param.name }}=${paramValue{{ loop.index }}}${paramPrefix{{ loop.index }}}`;
                }

            {% endfor %}
            document.getElementById('spice-string').value = modelString;
        }

        function resetSliders() {
            {% for param in parameters %}
            {% if param.default is not string %}
                slider{{ loop.index }}.noUiSlider.reset();
            {% endif %}
            {% endfor %}
        }

        function loadSpiceString() {
            // spice-stringの値を取得
            const spiceString = document.getElementById('spice-string').value;

            // fetchでPOSTリクエストを送信
            fetch('/api/parse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ spice_string: spiceString })
            })
            .then(response => response.json())
            .then(data => {
                if (data.parsed_params) {
                    // パース成功時
                    const parsedParams = data.parsed_params;

                    console.table(parsedParams);

                    // device-nameとdevice-type以外のパラメータを大文字小文字区別せずにロード
                    for (let param in parsedParams) {
                        if (param.toLowerCase() !== 'device_name' && param.toLowerCase() !== 'device_type') {
                            const paramName = param.toLowerCase(); // 大文字小文字区別しないため小文字に変換
                            
                            // 正規表現で一致するidを探す
                            const sliderElements = document.querySelectorAll('[id^="slider-"]'); // idが"value-"で始まる全ての要素を取得
                            
                            sliderElements.forEach(sliderElement => {
                                const sliderId = sliderElement.id.toLowerCase(); // idを小文字に変換
                                if (sliderId.includes(paramName)) { // idにparamNameが含まれていれば一致
                                    
                                    if (sliderElement.dataset.prefix === "p") {
                                        sliderElement.noUiSlider.set(parsedParams[param] * 1E+12 );
                                    } else if (sliderElement.dataset.prefix === "u") {
                                        sliderElement.noUiSlider.set(parsedParams[param] * 1E+6 );
                                    } else if (sliderElement.dataset.prefix === "m") {
                                        console.log(sliderElement.dataset.prefix, paramName, parsedParams[param], parsedParams[param] * 1E+3);
                                        sliderElement.noUiSlider.set(parsedParams[param] * 1E+3 );
                                    } else {
                                        sliderElement.noUiSlider.set(parsedParams[param]);
                                    }
                                }
                            });
                        }
                    }

                    // device-nameとdevice-typeは特別に処理
                    document.getElementById('device-name').value = parsedParams.device_name || '';
                    document.getElementById('device-type').value = parsedParams.device_type || '';

                    alert("Parameters Loaded Successfully!");
                } else if (data.error) {
                    // エラーがあれば
                    alert("Error: " + data.error);
                }
            })
            .catch(error => {
                // フェッチエラー
                alert("Fetch Error: " + error);
            });
        }

        document.getElementById('default-button').addEventListener('click', function() {
                resetSliders();
            });

        document.getElementById('load-button').addEventListener('click', function() {
                loadSpiceString() 
            });

        document.getElementById('device-name').addEventListener('change', function() {
            generateModel();
        });

        document.getElementById('device-type').addEventListener('change', function() {
            generateModel();
        });

        let sliderInstance;

        {% for param in parameters %}
        // Initialize slider only if min/max is not None
        {% if param.default is not string %}
        const slider{{ loop.index }} = document.getElementById('slider-{{ param.name }}');
        
        noUiSlider.create(slider{{ loop.index }}, {
            start: {{ param.default }},
            range: {
                min: {{ param.min }},
                max: {{ param.max }}
            },
            step: 0.001
        });

        // Link slider with input
        const input{{ loop.index }} = document.getElementById('value-{{ param.name }}');
        slider{{ loop.index }}.noUiSlider.on('update', (values) => {
            input{{ loop.index }}.value = values[0];
            generateModel();
        });

        {% endif %}
        {% endfor %}

    </script>
</body>
</html>
