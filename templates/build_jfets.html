<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPICE Model Editor</title>
    <!-- bokeh -->
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <style>
        /* Custom styles for the sliders */
        .noUi-horizontal {
            height: 8px;
            background: #ddd;
        }
        .noUi-handle {
            background: #4CAF50;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
        }

        /* Adjust the layout to prevent overlap */
        .parameter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .parameter-container input[type="text"] {
            flex: 1;
        }

        .parameter-container .slider-container {
            width: 100%;
        }

        .parameter-container .slider-container .noUi-slider {
            margin-top: 8px;
        }
    </style>


    <!-- Simulation Request -->
    <script type="text/javascript">
        // 非同期リクエストを送信し、結果をBokehで表示する関数
        async function runSimulation(event) {
            event.preventDefault();  // フォームのデフォルト送信を防ぐ

            const formData = new FormData(document.getElementById("build-form"));
            try {
                const response = await fetch("/api/simulate_now2", {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    alert("Simulation failed: " + response.statusText);
                    return;
                }

                const jsonData = await response.json();
                if (jsonData.error) {
                    alert("Error: " + jsonData.error);
                    return;
                }

                // Bokehプロットを表示するための処理
                const bokehDiv = document.getElementById("bokeh-plot");
                bokehDiv.innerHTML = '';  // 既存のプロットをクリア

                // Bokehプロットの埋め込み
                Bokeh.safely(function() {
                    // JSONデータが正しく埋め込まれるように処理
                    Bokeh.embed.embed_item(JSON.parse(jsonData), "bokeh-plot");
                });

                // 結果セクションを表示
                document.getElementById("result-section").style.display = "block";
            } catch (error) {
                console.error("Error during simulation:", error);
                alert("An unexpected error occurred. Please try again.");
            }
        }

        // DOMが読み込まれた後にイベントリスナーを設定
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("build-form");
            // const form = document.querySelector("form");
            form.addEventListener("submit", runSimulation);
        });
    </script>


</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div class="container mx-auto p-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">SPICE Model Editor</h1>
            <h2 class="text-xl text-gray-600">Create and customize your own SPICE models for simulation</h2>
        </header>

        <!-- Flexbox Layout -->
        <div class="flex flex-wrap lg:flex-nowrap gap-6">
            <!-- Left Column: Forms -->
            <div class="w-full lg:w-1/3 space-y-6">
                <!-- Parameter Form -->
                <form id="parameter-form" class="bg-white p-6 rounded-lg shadow-md">
                    <!-- Device Name and Type -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="device-name" class="block text-lg font-semibold text-gray-700">Device Name:</label>
                            <input type="text" id="device-name" name="device-name" class="w-full border rounded-lg py-2 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter device name" value="2SK555">
                        </div>
                        <div>
                            <label for="device-type" class="block text-lg font-semibold text-gray-700">Device Type:</label>
                            <select id="device-type" name="device-type" class="w-full border rounded-lg py-2 px-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="NJF">NJF</option>
                                <option value="PJF">PJF</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="flex border-b mb-6">
                        <li class="mr-2">
                            <a href="#tab-1" class="inline-block py-2 px-4 text-blue-500 hover:text-blue-700 font-semibold">Tab 1</a>
                        </li>
                        <li class="mr-2">
                            <a href="#tab-2" class="inline-block py-2 px-4 text-gray-500 hover:text-blue-700">Tab 2</a>
                        </li>
                        <li class="mr-2">
                            <a href="#tab-3" class="inline-block py-2 px-4 text-gray-500 hover:text-blue-700">Tab 3</a>
                        </li>
                        <li class="mr-2">
                            <a href="#tab-4" class="inline-block py-2 px-4 text-gray-500 hover:text-blue-700">Tab 4</a>
                        </li>
                        <li class="mr-2">
                            <a href="#tab-5" class="inline-block py-2 px-4 text-gray-500 hover:text-blue-700">Tab 5</a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div id="tab-1" class="space-y-4">
                        {% for param in parameters[:5] %}
                        <div class="parameter-container">
                            <label for="value-{{ param.name }}" class="w-1/4 text-lg font-semibold text-gray-700">{{ param.name }}:</label>
                            <div class="slider-container flex-1">
                                <input type="text" id="value-{{ param.name }}" class="w-full text-center border rounded-lg py-2 px-4" value="{{ param.default }}">
                                <div id="slider-{{ param.name }}" class="mt-2"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="tab-2" class="space-y-4 hidden">
                        {% for param in parameters[5:10] %}
                        <div class="parameter-container">
                            <label for="value-{{ param.name }}" class="w-1/4 text-lg font-semibold text-gray-700">{{ param.name }}:</label>
                            <div class="slider-container flex-1">
                                <input type="text" id="value-{{ param.name }}" class="w-full text-center border rounded-lg py-2 px-4" value="{{ param.default }}">
                                <div id="slider-{{ param.name }}" class="mt-2"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="tab-3" class="space-y-4 hidden">
                        {% for param in parameters[10:15] %}
                        <div class="parameter-container">
                            <label for="value-{{ param.name }}" class="w-1/4 text-lg font-semibold text-gray-700">{{ param.name }}:</label>
                            <div class="slider-container flex-1">
                                <input type="text" id="value-{{ param.name }}" class="w-full text-center border rounded-lg py-2 px-4" value="{{ param.default }}">
                                <div id="slider-{{ param.name }}" class="mt-2"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="tab-4" class="space-y-4 hidden">
                        {% for param in parameters[15:20] %}
                        <div class="parameter-container">
                            <label for="value-{{ param.name }}" class="w-1/4 text-lg font-semibold text-gray-700">{{ param.name }}:</label>
                            <div class="slider-container flex-1">
                                <input type="text" id="value-{{ param.name }}" class="w-full text-center border rounded-lg py-2 px-4" value="{{ param.default }}">
                                <div id="slider-{{ param.name }}" class="mt-2"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="tab-5" class="space-y-4 hidden">
                        {% for param in parameters[20:26] %}
                        <div class="parameter-container">
                            <label for="value-{{ param.name }}" class="w-1/4 text-lg font-semibold text-gray-700">{{ param.name }}:</label>
                            <div class="slider-container flex-1">
                                <input type="text" id="value-{{ param.name }}" class="w-full text-center border rounded-lg py-2 px-4" value="{{ param.default }}">
                                <div id="slider-{{ param.name }}" class="mt-2"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </form>

                <!-- Build Form -->
                <form id="build-form" action="/api/simulate_now2" method="post" class="bg-white p-6 rounded-lg shadow-md">
                    <textarea id="spice-string" name="spice_string" placeholder="Enter SPICE model string here" required class="w-full h-30 p-3 text-lg border border-gray-300 rounded mb-4"></textarea>
                    <div class="form-row" style="display:none;">
                        <input type="text" name="author" placeholder="Your Name" maxlength="16" class="w-1/2 p-3 text-lg border border-gray-300 rounded mr-4">
                        <input type="text" name="comment" placeholder="Add a comment" maxlength="100" class="w-1/2 p-3 text-lg border border-gray-300 rounded">
                    </div>
                    <button type="submit" class="bg-blue-500 text-white font-semibold text-lg py-3 px-6 rounded hover:bg-blue-600 transition duration-300">Run Simulation</button>
                </form>
            </div>

            <!-- Right Column: Result Section -->
            <div class="w-full lg:w-2/3">
                <div class="bg-white p-6 rounded-lg shadow-md" id="result-section" style="display: none;">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Simulation Result</h3>
                    <div id="bokeh-plot" class="w-full h-full mb-4" style="max-width: 100%; max-height: 600px;"></div>
                    <p id="result-message" class="text-lg text-gray-600"></p>
                </div>
            </div>
        </div>

        <!-- Back to Home -->
        <p><a href="{{ url_for('home') }}" class="text-blue-500 text-lg hover:underline">Back to Home</a></p>
    </div>

    <!-- Tab Click event -->
    <script>
        // タブのクリックイベントを設定
        document.querySelectorAll('a[href^="#tab-"]').forEach(tab => {
            tab.addEventListener('click', function(event) {
                event.preventDefault(); // デフォルトのリンク動作を無効化

                // すべてのタブを非アクティブにし、関連するコンテンツを非表示にする
                document.querySelectorAll('a[href^="#tab-"]').forEach(tabLink => {
                    tabLink.classList.remove('text-blue-700');
                    tabLink.classList.add('text-gray-500');
                });
                document.querySelectorAll('.space-y-4').forEach(tabContent => {
                    tabContent.classList.add('hidden');
                });

                // クリックされたタブをアクティブにし、関連するコンテンツを表示する
                this.classList.remove('text-gray-500');
                this.classList.add('text-blue-700');
                const targetTab = document.querySelector(this.getAttribute('href'));
                targetTab.classList.remove('hidden');
            });
        });

        // spice model string
        function generateModel() {
            const deviceName = document.getElementById('device-name').value;
            const deviceType = document.getElementById('device-type').value;
            let modelString = `.MODEL ${deviceName} ${deviceType}`;

            {% for param in parameters %}
                const paramValue{{ loop.index }} = document.getElementById('value-{{ param.name }}').value;
                const paramPrefix{{ loop.index }} = "{{ param.prefix }}";  // Get the prefix (e.g., 'p', 'u', etc.)

                // Check if the value is a string or a number, and decide what to do
                modelString += ` {{ param.name }}=${paramValue{{ loop.index }}}${paramPrefix{{ loop.index }}}`;  // Append the value with the prefix

            {% endfor %}
            document.getElementById('spice-string').value = modelString;
        }

        document.getElementById('device-name').addEventListener('change', function() {
            generateModel();
        });

        document.getElementById('device-type').addEventListener('change', function() {
            generateModel();
        });

        {% for param in parameters %}
        // Initialize slider only if min/max is not None
        {% if param.min is not none and param.max is not none %}
        const slider{{ loop.index }} = document.getElementById('slider-{{ param.name }}');
        noUiSlider.create(slider{{ loop.index }}, {
            start: {{ param.default }},
            range: {
                min: {{ param.min }},
                max: {{ param.max }}
            },
            step: 0.1
        });

        // Link slider with input
        const input{{ loop.index }} = document.getElementById('value-{{ param.name }}');
        slider{{ loop.index }}.noUiSlider.on('update', (values) => {
            input{{ loop.index }}.value = values[0];
            generateModel();
        });

        {% endif %}
        {% endfor %}

    </script>
</body>
</html>
