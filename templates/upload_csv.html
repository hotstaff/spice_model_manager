<!DOCTYPE html>
<html lang="{% block lang_code %}en{% endblock %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block head_title %}Upload CSV{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-6 text-center">{% block title %}Upload CSV File and Experiment Data{% endblock %}</h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4">
            {% for category, message in messages %}
            <div class="p-4 mb-4 text-sm text-white bg-{{ 'green' if category == 'success' else 'red' }}-600 rounded-lg">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form action="/upload_csv" method="POST" enctype="multipart/form-data">
            <div class="mb-4">
                <label for="data_id" class="block text-sm font-medium text-gray-700">{% block device_label %}Select Device{% endblock %}</label>
                <select name="data_id" id="data_id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    <option value="" disabled selected>{% block device_placeholder %}Select a device{% endblock %}</option>
                    {% for device in device_options %}
                        <option value="{{ device['id'] }}">{{ device['device_name'] }} ({{ device['device_type'] }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4">
                <label for="new_device" class="inline-flex items-center text-sm font-medium text-gray-700">
                    <input type="checkbox" id="new_device" name="new_device" class="mr-2">
                    {% block new_device_label %}Register New Device{% endblock %}
                </label>
            </div>

            <div class="mb-4" id="device_name_div" style="display: none;">
                <label for="device_name" class="block text-sm font-medium text-gray-700">{% block device_name_label %}Device Name{% endblock %}</label>
                <input type="text" name="device_name" id="device_name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="{% block device_name_placeholder %}Enter new device name{% endblock %}">
            </div>

            <div class="mb-4">
                <label for="measurement_type" class="block text-sm font-medium text-gray-700">{% block measurement_type_label %}Measurement Type{% endblock %}</label>
                <select name="measurement_type" id="measurement_type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    <!-- Measurement types are dynamically added by the backend or JavaScript -->
                </select>
            </div>

            <div class="mb-4">
                <label for="operator_name" class="block text-sm font-medium text-gray-700">{% block operator_name_label %}Operator Name{% endblock %}</label>
                <input type="text" name="operator_name" id="operator_name" value="Unknown" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>

            <div class="mb-4">
                <label for="file" class="block text-sm font-medium text-gray-700">{% block file_label %}CSV File{% endblock %}</label>
                <input type="file" name="file" id="file" accept=".csv" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>

            <div class="flex justify-center">
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">{% block submit_button %}Upload{% endblock %}</button>
            </div>
        </form>
    </div>

    <script>

        let availableMeasurementTypes = ['IV']; // 現在はIVのみ。将来的に増加予定

        window.onload = function() {
            const measurementTypeSelect = document.getElementById('measurement_type');
            const deviceNameDiv = document.getElementById('device_name_div');
            const new_Device = document.getElementById('new_device')

            deviceNameDiv.style.display = new_Device.checked ? 'block' : 'none';

            document.getElementById('new_device').addEventListener('change', function() {
                deviceNameDiv.style.display = this.checked ? 'block' : 'none';
            });

            // 測定タイプを動的に追加
            availableMeasurementTypes.forEach(function(type) {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                measurementTypeSelect.appendChild(option);
            });
        };
    </script>
</body>
</html>
